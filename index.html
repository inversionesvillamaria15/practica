<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kumite Trainer - Shito-Ryu</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #fff;
            overflow: hidden;
        }

        /* ========== DASHBOARD ========== */
        #dashboard {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            overflow-y: auto;
        }

        #dashboard.hidden {
            display: none;
        }

        .dashboard-container {
            background: rgba(26, 26, 46, 0.95);
            border: 2px solid #00ff41;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 0 40px rgba(0, 255, 65, 0.3);
            margin: 20px;
        }

        .dashboard-title {
            font-size: 36px;
            font-weight: bold;
            color: #00ff41;
            text-align: center;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .dashboard-subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 18px;
            color: #00ff41;
            margin-bottom: 15px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .techniques-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .technique-checkbox {
            display: flex;
            align-items: center;
            background: rgba(0, 255, 65, 0.1);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 65, 0.3);
            cursor: pointer;
            transition: all 0.3s;
        }

        .technique-checkbox:hover {
            background: rgba(0, 255, 65, 0.2);
            border-color: #00ff41;
        }

        .technique-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 15px;
            cursor: pointer;
            accent-color: #00ff41;
        }

        .technique-label {
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
        }

        .mode-selector {
            display: flex;
            gap: 15px;
        }

        .mode-option {
            flex: 1;
            background: rgba(0, 255, 65, 0.1);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid rgba(0, 255, 65, 0.3);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .mode-option:hover {
            background: rgba(0, 255, 65, 0.2);
            border-color: #00ff41;
        }

        .mode-option.selected {
            background: rgba(0, 255, 65, 0.3);
            border-color: #00ff41;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.3);
        }

        .mode-option input[type="radio"] {
            display: none;
        }

        .mode-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #00ff41;
        }

        .mode-description {
            font-size: 12px;
            color: #aaa;
        }

        .tabata-config {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 65, 0.2);
        }

        .tabata-config.active {
            display: block;
        }

        .config-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .config-row:last-child {
            margin-bottom: 0;
        }

        .config-label {
            font-size: 14px;
            color: #aaa;
        }

        .config-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .config-input input[type="number"] {
            width: 70px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 255, 65, 0.3);
            border-radius: 5px;
            color: #fff;
            font-size: 14px;
            text-align: center;
        }

        .config-input input[type="number"]:focus {
            outline: none;
            border-color: #00ff41;
        }

        .config-unit {
            font-size: 12px;
            color: #888;
        }

        .start-training-btn {
            width: 100%;
            padding: 18px;
            font-size: 20px;
            font-weight: bold;
            background: #00ff41;
            color: #000;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s;
            margin-top: 30px;
        }

        .start-training-btn:hover {
            background: #00cc33;
            transform: scale(1.02);
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.5);
        }

        .start-training-btn:active {
            transform: scale(0.98);
        }

        .start-training-btn:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .error-message {
            color: #ff4444;
            font-size: 14px;
            text-align: center;
            margin-top: 10px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* ========== TRAINING VIEW ========== */
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #videoElement {
            position: absolute;
            display: none;
        }

        #canvasElement {
            max-width: 100%;
            max-height: 100%;
            border: 2px solid #00ff41;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.3);
        }

        #overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #00ff41;
            min-width: 300px;
        }

        #technique {
            font-size: 32px;
            font-weight: bold;
            color: #00ff41;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        #repCounter {
            font-size: 72px;
            color: #ffaa00;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            text-align: center;
            margin: 10px 0;
        }

        #workTimer {
            font-size: 36px;
            color: #00ff41;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            text-align: center;
        }

        #status {
            margin-top: 10px;
            font-size: 14px;
            color: #888;
        }

        /* Tabata Timer */
        #tabataTimer {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 60px;
            border-radius: 20px;
            border: 3px solid #00ff41;
            text-align: center;
            z-index: 100;
        }

        #tabataTimer.active {
            display: block;
        }

        #tabataPhase {
            font-size: 36px;
            color: #00ff41;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        #tabataPhase.rest {
            color: #ffaa00;
        }

        #tabataCountdown {
            font-size: 120px;
            font-weight: bold;
            color: #00ff41;
            font-family: 'Courier New', monospace;
            line-height: 1;
        }

        #tabataCountdown.rest {
            color: #ffaa00;
        }

        #tabataRound {
            font-size: 24px;
            color: #888;
            margin-top: 20px;
        }

        #stats {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #00ff41;
            font-size: 12px;
        }

        .stat-row {
            margin: 5px 0;
        }

        .label {
            color: #888;
            display: inline-block;
            width: 120px;
        }

        .value {
            color: #00ff41;
            font-weight: bold;
        }

        #backButton {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            background: rgba(255, 68, 68, 0.8);
            color: #fff;
            border: 1px solid #ff4444;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            text-transform: uppercase;
            z-index: 50;
        }

        #backButton:hover {
            background: rgba(255, 68, 68, 1);
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.5);
        }

        .detected {
            animation: pulse 0.3s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* ========== STATISTICS SCREEN ========== */
        #statisticsScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            overflow-y: auto;
            padding: 20px;
        }

        #statisticsScreen.active {
            display: flex;
        }

        .stats-container {
            background: rgba(26, 26, 46, 0.95);
            border: 2px solid #00ff41;
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 0 40px rgba(0, 255, 65, 0.3);
            animation: slideIn 0.5s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stats-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .stats-title {
            font-size: 42px;
            font-weight: bold;
            color: #00ff41;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 10px;
        }

        .stats-subtitle {
            font-size: 16px;
            color: #888;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(0, 255, 65, 0.1);
            border: 2px solid rgba(0, 255, 65, 0.3);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s;
        }

        .stat-card:hover {
            background: rgba(0, 255, 65, 0.2);
            border-color: #00ff41;
            transform: translateY(-5px);
        }

        .stat-card-label {
            font-size: 14px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-card-value {
            font-size: 48px;
            font-weight: bold;
            color: #00ff41;
            font-family: 'Courier New', monospace;
        }

        .stat-card-unit {
            font-size: 18px;
            color: #888;
            margin-left: 5px;
        }

        .stats-section {
            margin-bottom: 30px;
        }

        .stats-section-title {
            font-size: 24px;
            color: #00ff41;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 2px solid rgba(0, 255, 65, 0.3);
            padding-bottom: 10px;
        }

        .technique-stats-grid {
            display: grid;
            gap: 15px;
        }

        .technique-stat-row {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 65, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .technique-stat-name {
            font-size: 18px;
            font-weight: bold;
            color: #00ff41;
            min-width: 200px;
        }

        .technique-stat-details {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .technique-stat-item {
            text-align: center;
        }

        .technique-stat-item-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }

        .technique-stat-item-value {
            font-size: 20px;
            font-weight: bold;
            color: #00ff41;
            font-family: 'Courier New', monospace;
        }

        .stats-actions {
            display: flex;
            gap: 15px;
            margin-top: 40px;
        }

        .stats-btn {
            flex: 1;
            padding: 18px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s;
        }

        .stats-btn-primary {
            background: #00ff41;
            color: #000;
        }

        .stats-btn-primary:hover {
            background: #00cc33;
            transform: scale(1.02);
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.5);
        }

        .stats-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .stats-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* Scrollbar styling */
        .stats-container::-webkit-scrollbar {
            width: 8px;
        }

        .stats-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .stats-container::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 65, 0.5);
            border-radius: 10px;
        }

        .stats-container::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 65, 0.7);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-container, .stats-container {
                padding: 20px;
            }

            .dashboard-title, .stats-title {
                font-size: 28px;
            }

            .mode-selector {
                flex-direction: column;
            }

            #tabataCountdown {
                font-size: 80px;
            }

            #repCounter {
                font-size: 56px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .technique-stat-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .technique-stat-name {
                min-width: auto;
            }

            .technique-stat-details {
                width: 100%;
                justify-content: space-between;
            }

            .stats-actions {
                flex-direction: column;
            }

            .stat-card-value {
                font-size: 36px;
            }
        }
    </style>
</head>
<body>
    <!-- ========== DASHBOARD ========== -->
    <div id="dashboard">
        <div class="dashboard-container">
            <h1 class="dashboard-title">Kumite Trainer</h1>
            <p class="dashboard-subtitle">Shito-Ryu â€¢ Personaliza tu entrenamiento</p>

            <div class="section">
                <div class="section-title">ðŸ“‹ TÃ©cnicas</div>
                <div class="techniques-grid">
                    <label class="technique-checkbox">
                        <input type="checkbox" id="tech-gyaku-tsuki" value="gyaku_tsuki" checked>
                        <span class="technique-label">Gyaku Tsuki</span>
                    </label>
                    <label class="technique-checkbox">
                        <input type="checkbox" id="tech-mawashi-jodan" value="mawashi_jodan" checked>
                        <span class="technique-label">Mawashi Geri Jodan</span>
                    </label>
                    <label class="technique-checkbox">
                        <input type="checkbox" id="tech-mawashi-chudan" value="mawashi_chudan" checked>
                        <span class="technique-label">Mawashi Geri Chudan</span>
                    </label>
                    <label class="technique-checkbox">
                        <input type="checkbox" id="tech-ura-mawashi" value="ura_mawashi" checked>
                        <span class="technique-label">Ura Mawashi Geri</span>
                    </label>
                </div>
            </div>

            <div class="section">
                <div class="section-title">âš¡ Modo de Entrenamiento</div>
                <div class="mode-selector">
                    <label class="mode-option selected" id="mode-normal-label">
                        <input type="radio" name="mode" value="normal" id="mode-normal" checked>
                        <div class="mode-title">Normal</div>
                        <div class="mode-description">TÃ©cnicas aleatorias continuas</div>
                    </label>
                    <label class="mode-option" id="mode-tabata-label">
                        <input type="radio" name="mode" value="tabata" id="mode-tabata">
                        <div class="mode-title">Tabata</div>
                        <div class="mode-description">Repeticiones mÃ¡ximas por tiempo</div>
                    </label>
                </div>

                <div class="tabata-config" id="tabata-config">
                    <div class="config-row">
                        <span class="config-label">Trabajo:</span>
                        <div class="config-input">
                            <input type="number" id="tabata-work" value="20" min="5" max="60">
                            <span class="config-unit">segundos</span>
                        </div>
                    </div>
                    <div class="config-row">
                        <span class="config-label">Descanso:</span>
                        <div class="config-input">
                            <input type="number" id="tabata-rest" value="10" min="5" max="60">
                            <span class="config-unit">segundos</span>
                        </div>
                    </div>
                    <div class="config-row">
                        <span class="config-label">Rondas:</span>
                        <div class="config-input">
                            <input type="number" id="tabata-rounds" value="8" min="1" max="20">
                            <span class="config-unit">ciclos</span>
                        </div>
                    </div>
                </div>
            </div>

            <button class="start-training-btn" id="startTrainingBtn">
                Iniciar Entrenamiento
            </button>
            <div class="error-message" id="error-message">
                Selecciona al menos una tÃ©cnica
            </div>
        </div>
    </div>

    <!-- ========== TRAINING VIEW ========== -->
    <div id="container">
        <button id="backButton">â—€ Finalizar</button>
        <video id="videoElement" autoplay playsinline></video>
        <canvas id="canvasElement"></canvas>
        
        <div id="overlay">
            <div id="technique">LISTO</div>
            <div id="repCounter">0</div>
            <div id="workTimer">0s</div>
            <div id="status">Iniciando...</div>
        </div>

        <div id="tabataTimer">
            <div id="tabataPhase">PREPARACIÃ“N</div>
            <div id="tabataCountdown">3</div>
            <div id="tabataRound">Ronda 1 de 8</div>
        </div>

        <div id="stats">
            <div class="stat-row">
                <span class="label">FPS:</span>
                <span class="value" id="fps">0</span>
            </div>
            <div class="stat-row">
                <span class="label">TÃ©cnicas Totales:</span>
                <span class="value" id="techniqueCount">0</span>
            </div>
            <div class="stat-row">
                <span class="label">Reps/Min Promedio:</span>
                <span class="value" id="avgRepsPerMin">0</span>
            </div>
        </div>
    </div>

    <!-- ========== STATISTICS SCREEN ========== -->
    <div id="statisticsScreen">
        <div class="stats-container">
            <div class="stats-header">
                <div class="stats-title">ðŸ¥‹ Resumen de SesiÃ³n</div>
                <div class="stats-subtitle">AnÃ¡lisis completo de tu entrenamiento</div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-label">TÃ©cnicas Totales</div>
                    <div class="stat-card-value" id="final-total-techniques">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-label">Reps/Min Promedio</div>
                    <div>
                        <span class="stat-card-value" id="final-avg-rpm">0</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-label">Mejor Ronda</div>
                    <div>
                        <span class="stat-card-value" id="final-best-round">0</span>
                        <span class="stat-card-unit">reps</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-label">DuraciÃ³n</div>
                    <div>
                        <span class="stat-card-value" id="final-duration">0:00</span>
                    </div>
                </div>
            </div>

            <div class="stats-section">
                <div class="stats-section-title">ðŸ“Š Desglose por TÃ©cnica</div>
                <div class="technique-stats-grid" id="technique-breakdown">
                </div>
            </div>

            <div class="stats-actions">
                <button class="stats-btn stats-btn-primary" id="newSessionBtn">
                    Nueva SesiÃ³n
                </button>
                <button class="stats-btn stats-btn-secondary" id="backToDashboardBtn">
                    Volver al MenÃº
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // CONFIGURACIÃ“N Y CONSTANTES
        // ============================================================================
        
        const CONFIG = {
            FRAME_BUFFER_SIZE: 15,
            DETECTION_COOLDOWN: 500, // Cooldown muy corto para repeticiones rÃ¡pidas
            MIN_DETECTION_CONFIDENCE: 0.65,
            VELOCITY_THRESHOLD: 0.10,
            ANGULAR_VELOCITY_THRESHOLD: 0.6,
            MIN_POSE_CONFIDENCE: 0.5,
            KICK_HEIGHT_JODAN: 0.4,
            KICK_HEIGHT_CHUDAN_MIN: 0.15,
            KICK_HEIGHT_CHUDAN_MAX: 0.5,
            LATERAL_MOVEMENT_MIN: 0.12,
            DEBUG_MODE: false
        };

        const ALL_TECHNIQUES = [
            { id: 'gyaku_tsuki', name: 'Gyaku Tsuki', voice: 'Gyaku Tsuki' },
            { id: 'mawashi_jodan', name: 'Mawashi Geri Jodan', voice: 'Mawashi Geri Jodan' },
            { id: 'mawashi_chudan', name: 'Mawashi Geri Chudan', voice: 'Mawashi Geri Chudan' },
            { id: 'ura_mawashi', name: 'Ura Mawashi Geri', voice: 'Ura Mawashi Geri' }
        ];

        // ============================================================================
        // DASHBOARD LOGIC
        // ============================================================================
        
        let selectedTechniques = [];
        let trainingMode = 'normal';
        let tabataConfig = {
            work: 20,
            rest: 10,
            rounds: 8
        };

        document.getElementById('mode-normal').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('mode-normal-label').classList.add('selected');
                document.getElementById('mode-tabata-label').classList.remove('selected');
                document.getElementById('tabata-config').classList.remove('active');
                trainingMode = 'normal';
            }
        });

        document.getElementById('mode-tabata').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('mode-tabata-label').classList.add('selected');
                document.getElementById('mode-normal-label').classList.remove('selected');
                document.getElementById('tabata-config').classList.add('active');
                trainingMode = 'tabata';
            }
        });

        document.getElementById('startTrainingBtn').addEventListener('click', async () => {
            selectedTechniques = [];
            document.querySelectorAll('.technique-checkbox input[type="checkbox"]:checked').forEach(checkbox => {
                const technique = ALL_TECHNIQUES.find(t => t.id === checkbox.value);
                if (technique) selectedTechniques.push(technique);
            });

            if (selectedTechniques.length === 0) {
                document.getElementById('error-message').classList.add('show');
                return;
            }

            if (trainingMode === 'tabata') {
                tabataConfig.work = parseInt(document.getElementById('tabata-work').value);
                tabataConfig.rest = parseInt(document.getElementById('tabata-rest').value);
                tabataConfig.rounds = parseInt(document.getElementById('tabata-rounds').value);
            }

            document.getElementById('dashboard').classList.add('hidden');
            
            if (!trainer) {
                trainer = new KumiteTrainer(selectedTechniques, trainingMode, tabataConfig);
                await trainer.startCamera();
            } else {
                trainer.updateConfig(selectedTechniques, trainingMode, tabataConfig);
            }
            
            trainer.startSession();
        });

        document.getElementById('backButton').addEventListener('click', () => {
            if (trainer) {
                trainer.finishSession();
            }
        });

        document.getElementById('newSessionBtn').addEventListener('click', async () => {
            document.getElementById('statisticsScreen').classList.remove('active');
            document.getElementById('dashboard').classList.remove('hidden');
        });

        document.getElementById('backToDashboardBtn').addEventListener('click', () => {
            document.getElementById('statisticsScreen').classList.remove('active');
            document.getElementById('dashboard').classList.remove('hidden');
        });

        // ============================================================================
        // CLASE PRINCIPAL: KUMITE TRAINER
        // ============================================================================
        
        class KumiteTrainer {
            constructor(techniques, mode, tabataConfig) {
                this.video = document.getElementById('videoElement');
                this.canvas = document.getElementById('canvasElement');
                this.ctx = this.canvas.getContext('2d');
                
                this.pose = null;
                this.camera = null;
                
                this.availableTechniques = techniques;
                this.trainingMode = mode;
                this.tabataConfig = tabataConfig;
                
                this.state = 'idle';
                this.currentTechnique = null;
                this.sessionStartTime = null;
                
                // Tabata state
                this.tabataState = {
                    currentRound: 0,
                    currentRoundReps: 0,
                    isWorkPhase: false,
                    isRestPhase: false,
                    countdown: 0,
                    workStartTime: 0,
                    intervalId: null,
                    workIntervalId: null,
                    roundStats: [] // {technique, reps, duration}
                };
                
                this.frameBuffer = [];
                this.lastDetectionTime = 0;
                
                this.stats = {
                    totalTechniques: 0,
                    techniqueBreakdown: {},
                    fps: 0,
                    lastFrameTime: performance.now()
                };
                
                this.synth = window.speechSynthesis;
                this.utterance = null;
                
                this.initializePose();
            }

            updateConfig(techniques, mode, tabataConfig) {
                this.availableTechniques = techniques;
                this.trainingMode = mode;
                this.tabataConfig = tabataConfig;
            }

            initializePose() {
                this.pose = new Pose({
                    locateFile: (file) => {
                        return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
                    }
                });

                this.pose.setOptions({
                    modelComplexity: 1,
                    smoothLandmarks: true,
                    enableSegmentation: false,
                    smoothSegmentation: false,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });

                this.pose.onResults((results) => this.onPoseResults(results));
            }

            async startCamera() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            facingMode: 'user'
                        }
                    });

                    this.video.srcObject = stream;
                    
                    await new Promise((resolve) => {
                        this.video.onloadedmetadata = () => {
                            this.canvas.width = this.video.videoWidth;
                            this.canvas.height = this.video.videoHeight;
                            resolve();
                        };
                    });

                    this.camera = new Camera(this.video, {
                        onFrame: async () => {
                            await this.pose.send({ image: this.video });
                        },
                        width: 1280,
                        height: 720
                    });

                    await this.camera.start();
                    this.updateStatus('CÃ¡mara iniciada. Preparado para entrenar.');
                    
                } catch (error) {
                    console.error('Error al iniciar cÃ¡mara:', error);
                    this.updateStatus('Error: No se pudo acceder a la cÃ¡mara');
                }
            }

            onPoseResults(results) {
                const now = performance.now();
                const delta = now - this.stats.lastFrameTime;
                this.stats.fps = Math.round(1000 / delta);
                this.stats.lastFrameTime = now;
                document.getElementById('fps').textContent = this.stats.fps;

                // Actualizar timer de trabajo si estamos en fase de trabajo
                if (this.tabataState.isWorkPhase) {
                    const elapsed = Math.floor((now - this.tabataState.workStartTime) / 1000);
                    document.getElementById('workTimer').textContent = `${elapsed}s`;
                }

                this.ctx.save();
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.drawImage(results.image, 0, 0, this.canvas.width, this.canvas.height);

                if (results.poseLandmarks) {
                    this.drawPose(results.poseLandmarks);
                    this.addFrameToBuffer(results.poseLandmarks);
                    
                    if (this.state === 'waiting' && this.frameBuffer.length >= CONFIG.FRAME_BUFFER_SIZE) {
                        this.detectTechnique();
                    }
                }

                this.ctx.restore();
            }

            drawPose(landmarks) {
                const connections = [
                    [11, 12], [11, 13], [13, 15], [15, 17], [15, 19], [15, 21],
                    [12, 14], [14, 16], [16, 18], [16, 20], [16, 22],
                    [11, 23], [12, 24], [23, 24],
                    [23, 25], [25, 27], [27, 29], [27, 31],
                    [24, 26], [26, 28], [28, 30], [28, 32]
                ];

                this.ctx.strokeStyle = '#00ff41';
                this.ctx.lineWidth = 2;
                connections.forEach(([start, end]) => {
                    const startPoint = landmarks[start];
                    const endPoint = landmarks[end];
                    if (startPoint && endPoint) {
                        this.ctx.beginPath();
                        this.ctx.moveTo(startPoint.x * this.canvas.width, startPoint.y * this.canvas.height);
                        this.ctx.lineTo(endPoint.x * this.canvas.width, endPoint.y * this.canvas.height);
                        this.ctx.stroke();
                    }
                });

                this.ctx.fillStyle = '#ff00ff';
                landmarks.forEach((landmark, index) => {
                    if (index >= 11) {
                        this.ctx.beginPath();
                        this.ctx.arc(
                            landmark.x * this.canvas.width,
                            landmark.y * this.canvas.height,
                            5,
                            0,
                            2 * Math.PI
                        );
                        this.ctx.fill();
                    }
                });
            }

            addFrameToBuffer(landmarks) {
                this.frameBuffer.push({
                    timestamp: performance.now(),
                    landmarks: landmarks
                });

                if (this.frameBuffer.length > CONFIG.FRAME_BUFFER_SIZE) {
                    this.frameBuffer.shift();
                }
            }

            detectTechnique() {
                const now = performance.now();
                
                // Cooldown muy corto para permitir repeticiones rÃ¡pidas
                if (now - this.lastDetectionTime < CONFIG.DETECTION_COOLDOWN) {
                    return;
                }

                let detected = false;
                let confidence = 0;
                let debugInfo = {};

                switch (this.currentTechnique.id) {
                    case 'gyaku_tsuki':
                        [detected, confidence, debugInfo] = this.detectGyakuTsuki();
                        break;
                    case 'mawashi_jodan':
                        [detected, confidence, debugInfo] = this.detectMawashiGeriJodan();
                        break;
                    case 'mawashi_chudan':
                        [detected, confidence, debugInfo] = this.detectMawashiGeriChudan();
                        break;
                    case 'ura_mawashi':
                        [detected, confidence, debugInfo] = this.detectUraMawashiGeri();
                        break;
                }

                if (CONFIG.DEBUG_MODE && this.state === 'waiting') {
                    console.log(`[${this.currentTechnique.id}] Confidence: ${confidence.toFixed(3)}`, debugInfo);
                }

                if (detected && confidence > CONFIG.MIN_DETECTION_CONFIDENCE) {
                    this.onTechniqueDetected();
                }
            }

            detectGyakuTsuki() {
                const current = this.frameBuffer[this.frameBuffer.length - 1].landmarks;
                const previous = this.frameBuffer[0].landmarks;

                const leftShoulder = current[11];
                const rightShoulder = current[12];
                const leftWrist = current[15];
                const rightWrist = current[16];

                const isLeftBack = leftShoulder.z > rightShoulder.z;
                const backWrist = isLeftBack ? leftWrist : rightWrist;
                const backWristPrev = isLeftBack ? previous[15] : previous[16];

                const wristVelocity = this.calculateVelocity(backWristPrev, backWrist);
                const extension = this.calculateDistance(
                    isLeftBack ? leftShoulder : rightShoulder,
                    backWrist
                );
                const forwardMovement = Math.abs(backWrist.z - backWristPrev.z);

                let confidence = 0;
                let debugInfo = { wristVelocity, extension, forwardMovement };

                if (wristVelocity > CONFIG.VELOCITY_THRESHOLD) confidence += 0.35;
                if (extension > 0.25) confidence += 0.35;
                if (forwardMovement > 0.05) confidence += 0.30;

                return [confidence > CONFIG.MIN_DETECTION_CONFIDENCE, confidence, debugInfo];
            }

            detectMawashiGeriJodan() {
                const current = this.frameBuffer[this.frameBuffer.length - 1].landmarks;
                const start = this.frameBuffer[0].landmarks;

                const leftAnkle = current[27];
                const rightAnkle = current[28];
                const leftKnee = current[25];
                const rightKnee = current[26];
                const leftHip = current[23];
                const rightHip = current[24];

                const isLeftKick = leftAnkle.y < rightAnkle.y;
                const kickAnkle = isLeftKick ? leftAnkle : rightAnkle;
                const kickKnee = isLeftKick ? leftKnee : rightKnee;
                const kickHip = isLeftKick ? leftHip : rightHip;
                const kickAnkleStart = isLeftKick ? start[27] : start[28];

                const nose = current[0];
                const hipAvg = (leftHip.y + rightHip.y) / 2;
                const bodyHeight = hipAvg - nose.y;

                const kickHeight = (hipAvg - kickAnkle.y) / bodyHeight;
                const isHighEnough = kickHeight > CONFIG.KICK_HEIGHT_JODAN;
                const lateralMovement = Math.abs(kickAnkle.x - kickAnkleStart.x);
                const kneeElevated = kickKnee.y < kickHip.y - 0.1;

                let confidence = 0;
                let debugInfo = { kickHeight, lateralMovement, kneeElevated, isHighEnough };

                if (isHighEnough) confidence += 0.40;
                if (lateralMovement > CONFIG.LATERAL_MOVEMENT_MIN) confidence += 0.30;
                if (kneeElevated) confidence += 0.30;

                return [confidence > CONFIG.MIN_DETECTION_CONFIDENCE, confidence, debugInfo];
            }

            detectMawashiGeriChudan() {
                const current = this.frameBuffer[this.frameBuffer.length - 1].landmarks;
                const mid = this.frameBuffer[Math.floor(this.frameBuffer.length / 2)].landmarks;
                const start = this.frameBuffer[0].landmarks;

                const leftAnkle = current[27];
                const rightAnkle = current[28];
                const leftKnee = current[25];
                const rightKnee = current[26];
                const leftHip = current[23];
                const rightHip = current[24];

                const isLeftKick = leftAnkle.y < rightAnkle.y;
                const kickAnkle = isLeftKick ? leftAnkle : rightAnkle;
                const kickKnee = isLeftKick ? leftKnee : rightKnee;
                const kickHip = isLeftKick ? leftHip : rightHip;
                const kickAnkleMid = isLeftKick ? mid[27] : mid[28];
                const kickAnkleStart = isLeftKick ? start[27] : start[28];

                const shoulder = (current[11].y + current[12].y) / 2;
                const hipAvg = (leftHip.y + rightHip.y) / 2;
                const bodyHeight = hipAvg - shoulder;

                const kickHeight = (hipAvg - kickAnkle.y) / bodyHeight;
                const isCorrectHeight = kickHeight >= CONFIG.KICK_HEIGHT_CHUDAN_MIN && 
                                       kickHeight <= CONFIG.KICK_HEIGHT_CHUDAN_MAX;
                const lateralMovement = Math.abs(kickAnkle.x - kickAnkleStart.x);
                const kneeHeight = (kickHip.y - kickKnee.y) / bodyHeight;
                const kneeElevated = kneeHeight > 0.15 && kneeHeight < 0.5;
                const circularPath = Math.abs(kickAnkleMid.x - kickAnkleStart.x) > 0.08;

                let confidence = 0;
                let debugInfo = { 
                    kickHeight, lateralMovement, kneeHeight, kneeElevated, 
                    circularPath, isCorrectHeight
                };

                if (isCorrectHeight) confidence += 0.35;
                if (lateralMovement > 0.10) confidence += 0.25;
                if (kneeElevated) confidence += 0.20;
                if (circularPath) confidence += 0.20;

                return [confidence > CONFIG.MIN_DETECTION_CONFIDENCE, confidence, debugInfo];
            }

            detectUraMawashiGeri() {
                const current = this.frameBuffer[this.frameBuffer.length - 1].landmarks;
                const start = this.frameBuffer[0].landmarks;

                const leftAnkle = current[27];
                const rightAnkle = current[28];
                const leftAnkleStart = start[27];
                const rightAnkleStart = start[28];

                const isLeftKick = leftAnkle.y < rightAnkle.y;
                const kickAnkle = isLeftKick ? leftAnkle : rightAnkle;
                const kickAnkleStart = isLeftKick ? leftAnkleStart : rightAnkleStart;

                const xMovement = kickAnkle.x - kickAnkleStart.x;
                const isInwardTrajectory = isLeftKick ? xMovement > 0.1 : xMovement < -0.1;
                const shoulder = (current[11].y + current[12].y) / 2;
                const isHighEnough = kickAnkle.y < shoulder;
                const totalMovement = Math.abs(xMovement);

                let confidence = 0;
                let debugInfo = { xMovement, isInwardTrajectory, isHighEnough, totalMovement };

                if (isInwardTrajectory) confidence += 0.40;
                if (isHighEnough) confidence += 0.30;
                if (totalMovement > 0.15) confidence += 0.30;

                return [confidence > CONFIG.MIN_DETECTION_CONFIDENCE, confidence, debugInfo];
            }

            calculateVelocity(prev, curr) {
                const dx = curr.x - prev.x;
                const dy = curr.y - prev.y;
                const dz = curr.z - prev.z;
                return Math.sqrt(dx * dx + dy * dy + dz * dz);
            }

            calculateDistance(p1, p2) {
                const dx = p2.x - p1.x;
                const dy = p2.y - p1.y;
                const dz = p2.z - p1.z;
                return Math.sqrt(dx * dx + dy * dy + dz * dz);
            }

            // ========================================================================
            // TABATA MODE
            // ========================================================================
            
            startTabataMode() {
                this.tabataState.currentRound = 0;
                this.tabataState.roundStats = [];
                
                this.showTabataTimer('PREPARACIÃ“N', 3, false);
                this.tabataState.countdown = 3;
                
                this.speak('PreparaciÃ³n', () => {
                    const prepInterval = setInterval(() => {
                        this.tabataState.countdown--;
                        this.updateTabataDisplay('PREPARACIÃ“N', this.tabataState.countdown, false);
                        
                        if (this.tabataState.countdown === 0) {
                            clearInterval(prepInterval);
                            this.startTabataRound();
                        }
                    }, 1000);
                });
            }

            startTabataRound() {
                this.tabataState.currentRound++;
                
                if (this.tabataState.currentRound > this.tabataConfig.rounds) {
                    this.endTabataSession();
                    return;
                }

                // Seleccionar tÃ©cnica aleatoria para esta ronda
                const randomIndex = Math.floor(Math.random() * this.availableTechniques.length);
                this.currentTechnique = this.availableTechniques[randomIndex];
                
                this.tabataState.currentRoundReps = 0;
                this.tabataState.isWorkPhase = true;
                this.tabataState.isRestPhase = false;
                this.tabataState.countdown = this.tabataConfig.work;
                this.tabataState.workStartTime = performance.now();
                
                this.hideTabataTimer();
                
                // Mostrar tÃ©cnica y contador
                document.getElementById('technique').textContent = this.currentTechnique.name;
                document.getElementById('repCounter').textContent = '0';
                document.getElementById('workTimer').textContent = '0s';
                
                this.speak(this.currentTechnique.voice, () => {
                    this.state = 'waiting';
                    this.updateStatus('Â¡Haz todas las repeticiones que puedas!');
                });
                
                // Timer global del periodo de trabajo
                const workInterval = setInterval(() => {
                    this.tabataState.countdown--;
                    
                    if (this.tabataState.countdown === 0) {
                        clearInterval(workInterval);
                        this.endWorkPhase();
                    }
                }, 1000);
                
                this.tabataState.workIntervalId = workInterval;
            }

            endWorkPhase() {
                this.state = 'cooldown';
                
                // Guardar estadÃ­sticas de la ronda
                this.tabataState.roundStats.push({
                    technique: this.currentTechnique.name,
                    techniqueId: this.currentTechnique.id,
                    reps: this.tabataState.currentRoundReps,
                    duration: this.tabataConfig.work
                });
                
                // Actualizar breakdown por tÃ©cnica
                if (!this.stats.techniqueBreakdown[this.currentTechnique.id]) {
                    this.stats.techniqueBreakdown[this.currentTechnique.id] = {
                        name: this.currentTechnique.name,
                        totalReps: 0,
                        rounds: [],
                        avgRepsPerRound: 0,
                        bestRound: 0
                    };
                }
                
                const breakdown = this.stats.techniqueBreakdown[this.currentTechnique.id];
                breakdown.totalReps += this.tabataState.currentRoundReps;
                breakdown.rounds.push(this.tabataState.currentRoundReps);
                breakdown.avgRepsPerRound = breakdown.totalReps / breakdown.rounds.length;
                breakdown.bestRound = Math.max(breakdown.bestRound, this.tabataState.currentRoundReps);
                
                this.startTabataRest();
            }

            startTabataRest() {
                this.tabataState.isWorkPhase = false;
                this.tabataState.isRestPhase = true;
                this.tabataState.countdown = this.tabataConfig.rest;
                
                this.showTabataTimer('DESCANSO', this.tabataConfig.rest, true);
                
                this.speak('Descanso', () => {
                    const restInterval = setInterval(() => {
                        this.tabataState.countdown--;
                        this.updateTabataDisplay('DESCANSO', this.tabataState.countdown, true);
                        
                        if (this.tabataState.countdown === 0) {
                            clearInterval(restInterval);
                            this.startTabataRound();
                        }
                    }, 1000);
                    
                    this.tabataState.intervalId = restInterval;
                });
            }

            showTabataTimer(phase, countdown, isRest) {
                const timer = document.getElementById('tabataTimer');
                timer.classList.add('active');
                this.updateTabataDisplay(phase, countdown, isRest);
            }

            hideTabataTimer() {
                document.getElementById('tabataTimer').classList.remove('active');
            }

            updateTabataDisplay(phase, countdown, isRest) {
                const phaseEl = document.getElementById('tabataPhase');
                const countdownEl = document.getElementById('tabataCountdown');
                const roundEl = document.getElementById('tabataRound');
                
                phaseEl.textContent = phase;
                countdownEl.textContent = countdown;
                roundEl.textContent = `Ronda ${this.tabataState.currentRound} de ${this.tabataConfig.rounds}`;
                
                if (isRest) {
                    phaseEl.classList.add('rest');
                    countdownEl.classList.add('rest');
                } else {
                    phaseEl.classList.remove('rest');
                    countdownEl.classList.remove('rest');
                }
            }

            endTabataSession() {
                this.showTabataTimer('Â¡COMPLETADO!', 'âœ“', false);
                this.updateStatus('SesiÃ³n Tabata completada. Â¡Excelente trabajo!');
                
                this.speak('SesiÃ³n completada. Excelente trabajo.', () => {
                    setTimeout(() => {
                        this.hideTabataTimer();
                        this.showStatistics();
                    }, 2000);
                });
            }

            // ========================================================================
            // GESTIÃ“N DE SESIÃ“N
            // ========================================================================
            
            startSession() {
                this.state = 'idle';
                this.stats.totalTechniques = 0;
                this.stats.techniqueBreakdown = {};
                this.sessionStartTime = Date.now();
                
                if (this.trainingMode === 'tabata') {
                    this.startTabataMode();
                } else {
                    this.nextTechnique();
                }
            }

            stopSession() {
                this.state = 'idle';
                if (this.tabataState.intervalId) {
                    clearInterval(this.tabataState.intervalId);
                }
                if (this.tabataState.workIntervalId) {
                    clearInterval(this.tabataState.workIntervalId);
                }
                this.hideTabataTimer();
                this.synth.cancel();
            }

            finishSession() {
                this.stopSession();
                this.speak('Entrenamiento finalizado', () => {
                    this.showStatistics();
                });
            }

            nextTechnique() {
                // Modo normal: tÃ©cnicas aleatorias continuas
                const randomIndex = Math.floor(Math.random() * this.availableTechniques.length);
                this.currentTechnique = this.availableTechniques[randomIndex];
                
                this.frameBuffer = [];
                document.getElementById('technique').textContent = this.currentTechnique.name;
                
                this.speak(this.currentTechnique.voice, () => {
                    this.state = 'waiting';
                    this.updateStatus('Â¡Ejecuta la tÃ©cnica!');
                });
            }

            onTechniqueDetected() {
                this.lastDetectionTime = performance.now();
                
                // Incrementar contadores
                this.stats.totalTechniques++;
                
                if (this.trainingMode === 'tabata' && this.tabataState.isWorkPhase) {
                    this.tabataState.currentRoundReps++;
                    document.getElementById('repCounter').textContent = this.tabataState.currentRoundReps;
                    
                    // AnimaciÃ³n de feedback
                    document.getElementById('repCounter').classList.add('detected');
                    setTimeout(() => {
                        document.getElementById('repCounter').classList.remove('detected');
                    }, 300);
                } else {
                    // Modo normal: pasar a siguiente tÃ©cnica
                    setTimeout(() => {
                        this.nextTechnique();
                    }, 1000);
                }
                
                // Actualizar estadÃ­sticas generales
                document.getElementById('techniqueCount').textContent = this.stats.totalTechniques;
                
                // Calcular reps por minuto promedio
                if (this.trainingMode === 'tabata' && this.tabataState.roundStats.length > 0) {
                    const totalReps = this.tabataState.roundStats.reduce((sum, r) => sum + r.reps, 0);
                    const totalMinutes = (this.tabataState.currentRound * (this.tabataConfig.work + this.tabataConfig.rest)) / 60;
                    const rpm = totalMinutes > 0 ? Math.round(totalReps / totalMinutes) : 0;
                    document.getElementById('avgRepsPerMin').textContent = rpm;
                }
            }

            updateStatus(message) {
                document.getElementById('status').textContent = message;
            }

            speak(text, callback) {
                this.synth.cancel();
                
                this.utterance = new SpeechSynthesisUtterance(text);
                this.utterance.lang = 'es-ES';
                this.utterance.rate = 1.0;
                this.utterance.pitch = 1.0;
                
                if (callback) {
                    this.utterance.onend = callback;
                }
                
                this.synth.speak(this.utterance);
            }

            // ========================================================================
            // ESTADÃSTICAS FINALES
            // ========================================================================
            
            showStatistics() {
                const sessionDuration = Date.now() - this.sessionStartTime;
                const minutes = Math.floor(sessionDuration / 60000);
                const seconds = Math.floor((sessionDuration % 60000) / 1000);
                
                // Calcular estadÃ­sticas
                const totalReps = this.tabataState.roundStats.reduce((sum, r) => sum + r.reps, 0);
                const avgRPM = sessionDuration > 0 ? Math.round((totalReps / sessionDuration) * 60000) : 0;
                const bestRound = this.tabataState.roundStats.reduce((max, r) => Math.max(max, r.reps), 0);
                
                document.getElementById('final-total-techniques').textContent = totalReps;
                document.getElementById('final-avg-rpm').textContent = avgRPM;
                document.getElementById('final-best-round').textContent = bestRound;
                document.getElementById('final-duration').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                // Desglose por tÃ©cnica
                const breakdownContainer = document.getElementById('technique-breakdown');
                breakdownContainer.innerHTML = '';
                
                Object.values(this.stats.techniqueBreakdown).forEach(tech => {
                    if (tech.totalReps > 0) {
                        const row = document.createElement('div');
                        row.className = 'technique-stat-row';
                        
                        const rpm = tech.rounds.length > 0 ? 
                            Math.round((tech.totalReps / (tech.rounds.length * this.tabataConfig.work)) * 60) : 0;
                        
                        row.innerHTML = `
                            <div class="technique-stat-name">${tech.name}</div>
                            <div class="technique-stat-details">
                                <div class="technique-stat-item">
                                    <div class="technique-stat-item-label">Total Reps</div>
                                    <div class="technique-stat-item-value">${tech.totalReps}</div>
                                </div>
                                <div class="technique-stat-item">
                                    <div class="technique-stat-item-label">Promedio/Ronda</div>
                                    <div class="technique-stat-item-value">${tech.avgRepsPerRound.toFixed(1)}</div>
                                </div>
                                <div class="technique-stat-item">
                                    <div class="technique-stat-item-label">Mejor Ronda</div>
                                    <div class="technique-stat-item-value">${tech.bestRound}</div>
                                </div>
                                <div class="technique-stat-item">
                                    <div class="technique-stat-item-label">Reps/Min</div>
                                    <div class="technique-stat-item-value">${rpm}</div>
                                </div>
                            </div>
                        `;
                        
                        breakdownContainer.appendChild(row);
                    }
                });
                
                document.getElementById('statisticsScreen').classList.add('active');
            }
        }

        // ============================================================================
        // INICIALIZACIÃ“N
        // ============================================================================
        
        let trainer = null;

        window.addEventListener('beforeunload', () => {
            if (trainer && trainer.synth) {
                trainer.synth.cancel();
            }
        });
    </script>
</body>
</html>
```

# ðŸ¥Š Cambios Principales - Modo Tabata de Repeticiones:

## 1. **Sin Cooldown entre TÃ©cnicas**
- Cooldown reducido a **500ms** (antes 1000ms)
- Permite hacer repeticiones rÃ¡pidas de la misma tÃ©cnica
- No hay timeout que te fuerce a cambiar

## 2. **Mismo TÃ©cnica Durante Todo el Periodo**
- Cada ronda = **UNA tÃ©cnica aleatoria**
- Ejemplo Ronda 1: 20s de Gyaku Tsuki â†’ cuÃ¡ntos puedes hacer
- Ronda 2: 20s de Mawashi Geri Jodan â†’ repetir
- Y asÃ­ sucesivamente

## 3. **Contador de Repeticiones en Tiempo Real**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GYAKU TSUKI       â”‚
â”‚      15            â”‚ â† Contador grande
â”‚      12s           â”‚ â† Tiempo transcurrido
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 4. **Nuevas MÃ©tricas**
- **Total Reps**: Repeticiones totales en la sesiÃ³n
- **Reps/Min Promedio**: Velocidad promedio
- **Mejor Ronda**: MÃ¡ximo nÃºmero de reps en una ronda
- **Promedio/Ronda**: Por tÃ©cnica

## 5. **EstadÃ­sticas por TÃ©cnica**
```
Gyaku Tsuki:
- Total Reps: 45
- Promedio/Ronda: 15.0
- Mejor Ronda: 18
- Reps/Min: 45
```

## Flujo Tabata Mejorado:
```
1. PreparaciÃ³n: 3s
2. Ronda 1: "Gyaku Tsuki"
   â†’ 0... 1... 2... 15! (en 20s)
3. Descanso: 10s
4. Ronda 2: "Mawashi Geri Jodan"
   â†’ 0... 1... 2... 8! (en 20s)
5. Repetir 8 rondas
6. "SesiÃ³n completada"
7. EstadÃ­sticas
