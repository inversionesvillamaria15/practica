<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Dojo AI â€“ Kumite Trainer</title>
<style>
body {
  margin: 0;
  background: #0b0b0b;
  color: #fff;
  font-family: Arial, sans-serif;
  text-align: center;
}

h1 {
  margin: 10px;
}

canvas {
  width: 100%;
  max-width: 900px;
}

#info {
  font-size: 20px;
  margin: 10px;
}
</style>
</head>

<body>
<h1>ðŸ¥‹ Dojo AI â€“ Kumite</h1>
<div id="info">Preparandoâ€¦</div>

<video id="input_video" style="display:none"></video>
<canvas id="output_canvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
const video = document.getElementById("input_video");
const canvas = document.getElementById("output_canvas");
const ctx = canvas.getContext("2d");
const info = document.getElementById("info");

let tecnicaActual = null;
let esperando = false;
let inicioTiempo = 0;

// ===================== VOZ =====================
function hablar(texto) {
  const msg = new SpeechSynthesisUtterance(texto);
  msg.lang = "es-ES";
  speechSynthesis.speak(msg);
}

// ===================== TECNICAS =====================
const tecnicas = [
  "Gyaku Tsuki",
  "Mawashi Geri Jodan",
  "Mawashi Geri Chudan",
  "Ura Mawashi Geri"
];

function nuevaTecnica() {
  tecnicaActual = tecnicas[Math.floor(Math.random() * tecnicas.length)];
  info.textContent = tecnicaActual;
  hablar(tecnicaActual);
  esperando = true;
  inicioTiempo = performance.now();
}

// ===================== DETECCIÃ“N =====================
let lastRightWristX = null;
let lastRightAnkleY = null;
let lastRightAnkleX = null;

function detectarTecnica(lm) {
  const rw = lm[16]; // muÃ±eca derecha
  const ra = lm[28]; // tobillo derecho

  if (!rw || !ra) return false;

  // Gyaku Tsuki
  if (tecnicaActual === "Gyaku Tsuki") {
    if (lastRightWristX !== null && rw.x - lastRightWristX > 0.04) return true;
    lastRightWristX = rw.x;
  }

  // Mawashi Geri Jodan
  if (tecnicaActual === "Mawashi Geri Jodan") {
    if (lastRightAnkleY !== null && ra.y < 0.35) return true;
    lastRightAnkleY = ra.y;
  }

  // Mawashi Geri Chudan
  if (tecnicaActual === "Mawashi Geri Chudan") {
    if (lastRightAnkleY !== null && ra.y < 0.55) return true;
    lastRightAnkleY = ra.y;
  }

  // Ura Mawashi Geri
  if (tecnicaActual === "Ura Mawashi Geri") {
    if (lastRightAnkleX !== null && Math.abs(ra.x - lastRightAnkleX) > 0.06) return true;
    lastRightAnkleX = ra.x;
  }

  return false;
}

// ===================== POSE =====================
const pose = new Pose({
  locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
});

pose.setOptions({
  modelComplexity: 1,
  smoothLandmarks: true,
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5
});

pose.onResults(results => {
  canvas.width = results.image.width;
  canvas.height = results.image.height;

  ctx.drawImage(results.image, 0, 0);

  if (results.poseLandmarks) {
    drawSkeleton(results.poseLandmarks);

    if (esperando && detectarTecnica(results.poseLandmarks)) {
      const tiempo = ((performance.now() - inicioTiempo) / 1000).toFixed(2);
      hablar(`Bien. Tiempo ${tiempo} segundos`);
      info.textContent = `âœ” ${tecnicaActual} â€“ ${tiempo}s`;
      esperando = false;
      setTimeout(nuevaTecnica, 3000);
    }
  }
});

// ===================== DIBUJO =====================
function drawSkeleton(lm) {
  ctx.fillStyle = "red";
  lm.forEach(p => {
    ctx.beginPath();
    ctx.arc(p.x * canvas.width, p.y * canvas.height, 5, 0, Math.PI * 2);
    ctx.fill();
  });
}

// ===================== CAMARA =====================
const camera = new Camera(video, {
  onFrame: async () => await pose.send({ image: video }),
  width: 900,
  height: 600
});

camera.start();
setTimeout(nuevaTecnica, 4000);
</script>

</body>
</html>
